---
title: "Latihan 3 MPDW"
author: "Wiska Radhia Firdaus - G1401231017"
date: "2025-09-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Library

```{r}
library(dLagM)
library(dynlm)
library(MLmetrics)
library(lmtest)
library(car)
library(readr)
library(dplyr)
```

# Import Data

```{r}
df <- read.csv("D:\\File\\Data Science\\Semester 5\\MPDW\\Praktikum\\Minggu 4\\NewDelhi_Air_quality.csv")
df
```

```{r}
str(df)
```

```{r}
data <- df %>% select(-c('X', 'datetime', 'no2', 'o3', 'pm10', 'pm25', 'so2', 'timestamp_local', 'timestamp_utc', 'ts'))
head(data)
```

Variabel yang digunakan adalah AQI sebagai variabel dependen dan CO sebagai variabel independen.

# Pembagian Data

```{r}
train<-data[1:54,]
test<-data[55:72,]
```

Pembagian data menggunakan rasio 3:1, dimana train berjumlah 54 amatan dan test berjumlah 18 amatan.

```{r}
train.ts<-ts(train)
test.ts<-ts(test)
data.ts<-ts(data)
```

# Model Koyck
## Pemodelan

```{r}
model.koyck <- koyckDlm(x = train$CO, y = train$AQI)
summary(model.koyck)
```

```{r}
AIC(model.koyck)
BIC(model.koyck)
```

Dari hasil tersebut, didapat bahwa peubah $AQI_{-1}$ memiliki nilai $p-value<0.05$. Hal ini menunjukkan bahwa peubah $AQI_{-1}$ berpengaruh signifikan terhadap $AQI$. Model ini juga memiliki nilai adjusted R-sq sebesar 0.8104. Adapun model keseluruhannya adalah sebagai berikut.

$$
\hat{AQI_t}=5.28397-0.01370CO_t+0.90541AQI_{t-1}
$$

## Peramalan dan Akurasi

Berikut adalah hasil peramalan $AQI$ untuk 18 periode kedepan menggunakan model koyck.

```{r}
fore.koyck <- forecast(model = model.koyck, x=test$CO, h=18)
fore.koyck
```

```{r}
mape.koyck <- MAPE(fore.koyck$forecasts, test$AQI)
mape.koyck 
```

```{r}
GoF(model.koyck)
```

Model tersebut merupakan model yang sangat baik dengan nilai MAPE yang kurang dari 10%.

# Regression with Distributed Lag
## Pemodelan (Lag=2)

```{r}
model.dlm <- dlm(x = train$CO,y = train$AQI , q = 1)
summary(model.dlm)
```

```{r}
AIC(model.dlm)
BIC(model.dlm)
```

Dari hasil tersebut didapat bahwa $p-value$ dari intercept dan $CO_{t-1}<0.05$. Hal ini menunjukkan bahwa intercept dan $CO_{t-1}$ berpengaruh signifikan terhadap $AQI$. Tetapi, nilai adjusted R-sq nya lebih kecil dibandingkan dengan model koyck yaitu hanya sebesar 0.4036. Adapun model keseluruhan yang terbentuk adalah sebagai berikut.

$$
\hat{AQI_t}=-48.44635+0.44673CO_t-0.07176CO_{t-1}
$$

## Peramalan dan Akurasi

Berikut merupakan hasil peramalan $AQI$ untuk 18 periode kedepan.

```{r}
fore.dlm <- forecast(model = model.dlm, x=test$CO, h=18)
fore.dlm
```

```{r}
mape.dlm <- MAPE(fore.dlm$forecasts, test$AQI)
mape.dlm
```

```{r}
GoF(model.dlm)
```

Model tersebut merupakan model yang sangat baik dengan nilai MAPE yang kurang dari 10%.

## *Lag* Optimum

```{r}
finiteDLMauto(formula = AQI ~ CO,
              data = data.frame(train), q.min = 1, q.max = 30,
              model.type = "dlm", error.type = "AIC", trace = TRUE)
```

Berdasarkan output tersebut, lag optimum didapatkan ketika lag = 25. Selanjutnya dilakukan pemodelan untuk lag = 25.

```{r}
model.dlm2 <- dlm(x = train$CO,y = train$AQI , q = 25)
summary(model.dlm2)
```

```{r}
AIC(model.dlm2)
BIC(model.dlm2)
```

Dari hasil tersebut terdapat beberapa peubah yang berpengaruh signifikan terhadap taraf nyata 5% yaitu $CO_{t-5}$ , $CO_{t-8}$ , $CO_{t-18}$ , $CO_{t-20}$ , $CO_{t-21}$ , $CO_{t-25}$. Model ini juga memiliki nilai R-sq sebesar 0.9822. Adapun keseluruhan model yang terbentuk adalah.

$$
\hat{AQI_t}=1.862 \times 10^{3}-0.7470CO_t+...-0.9450CO_{t-25}
$$

Adapun hasil peramalan 18 periode kedepan menggunakan model tersebut adalah sebagai berikut.

```{r}
fore.dlm2 <- forecast(model = model.dlm2, x=test$CO, h=18)
fore.dlm2
```

```{r}
mape.dlm2<- MAPE(fore.dlm2$forecasts, test$AQI)
mape.dlm2
```

```{r}
GoF(model.dlm2)
```

Model tersebut merupakan model yang sangat baik dengan nilai MAPE yang kurang dari 10%.

# Model Autoregressive
## Pemodelan

```{r}
model.ardl <- ardlDlm(x = train$CO, y = train$AQI, p = 1 , q = 1)
summary(model.ardl)
```

```{r}
AIC(model.ardl)
BIC(model.ardl)
```

```{r}
model.ardl <- ardlDlm(formula = AQI ~ CO, 
                         data = train,p = 1 , q = 1)
summary(model.ardl)
```

```{r}
AIC(model.ardl)
BIC(model.ardl)
```

Hasil di atas menunjukkan bahwa seluruh peubah yaitu $CO_t$ , $CO_{t-1}$ , dan $AQI_{t-1}$ hasil uji t menunjukkan nilai-p pada peubah $<0.05$. Hal ini menunjukkan bahwa peubah $CO_t$ , $CO_{t-1}$ , dan $AQI_{t-1}$ berpengaruh signifikan terhadap $AQI_t$. Model ini juga memiliki nilai adj R-sq sebesar 0.8461. Model keseluruhannya adalah sebagai berikut:

$$
\hat{AQI_t}=-3.91203+0.23326CO_t-0.19286CO_{t-1}+0.84215AQI_{t-1}
$$

## Peramalan dan Akurasi

```{r}
fore.ardl <- forecast(model = model.ardl, x=test$CO, h=18)
fore.ardl
```

Data di atas merupakan hasil peramalan untuk 18 periode ke depan menggunakan Model Autoregressive dengan $p=1$ dan $q=1$.

```{r}
mape.ardl <- MAPE(fore.ardl$forecasts, test$AQI)
mape.ardl
```

```{r}
GoF(model.ardl)
```

Berdasarkan akurasi di atas, terlihat bahwa nilai MAPE keduanya tidak jauh berbeda. Artinya, model regresi dengan distribusi lag ini tidak `overfitted` atau `underfitted`

## *Lag* Optimum

```{r}
model.ardl.opt <- ardlBoundOrders(data = data.frame(data), ic = "AIC", 
                                  formula = AQI ~ CO )
model.ardl.opt
```

```{r}
min_p=c()
for(i in 1:15){
  min_p[i]=min(model.ardl.opt$Stat.table[[i]])
}
q_opt=which(min_p==min(min_p, na.rm = TRUE))
p_opt=which(model.ardl.opt$Stat.table[[q_opt]] == 
              min(model.ardl.opt$Stat.table[[q_opt]], na.rm = TRUE))
data.frame("q_optimum" = q_opt, "p_optimum" = p_opt, 
           "AIC"=model.ardl.opt$min.Stat)
```

Dari tabel di atas, dapat terlihat bahwa nilai AIC terendah didapat ketika $p=15$ dan $q=6$, yaitu sebesar $121.7055$. Artinya, model autoregressive optimum didapat ketika $p=15$ dan $q=6$.

Selanjutnya dapat dilakukan pemodelan dengan nilai $p$ dan $q$ optimum.

# Pemodelan DLM & ARDL

```{r}
cons_lm1 <- dynlm(AQI ~ CO+L(CO),data = train.ts)

cons_lm2 <- dynlm(AQI ~ CO+L(AQI),data = train.ts)

cons_lm3 <- dynlm(AQI ~ CO+L(CO)+L(AQI),data = train.ts)

cons_lm4 <- dynlm(AQI ~ CO+L(AQI)+L(CO,2),data = train.ts)
```

## Ringkasan Model

Berikut adalah ringkasan hasil estimasi dari masing-masing model:

```{r}
summary(cons_lm1)
```

```{r}
summary(cons_lm2)
```

```{r}
summary(cons_lm3)
```

```{r}
summary(cons_lm4)
```

## SSE

Selain ringkasan hasil, kita juga bisa menghitung nilai SSE dari masing-masing model.

```{r}
deviance(cons_lm1)
deviance(cons_lm2)
deviance(cons_lm3)
deviance(cons_lm4)
```

Semakin kecil nilai SSE, berarti model lebih baik dalam menyesuaikan data (karena error lebih kecil). Artinya, model 4 lebih baik diantara model tersebut.

## Ui encomptest

```{r}
if(require("lmtest")) encomptest(cons_lm1, cons_lm2)
```

-   Model 1 : p-value $3.074 \times 10^{-16}$ (\< 0.05). Artinya, penambahan lag dari AQI (`L(AQI)`) memberikan peningkatan signifikan.\
    Dengan demikian, Model 1 tidak cukup memadai.

-   Model 2 : p-value = 0.006412 (\< 0.05).\
    Artinya, penambahan lag dari CO (`L(CO)`) memberikan peningkatan signifikan. Sehingga Model 2 tidak cukup memadai tanpa tambahan variabel lag dari CO.

### Uji Autokorelasi Residual

```{r}
dwtest(cons_lm1)
dwtest(cons_lm2)
dwtest(cons_lm3)
dwtest(cons_lm4)
```

Dari hasil uji Durbin-Watson diatas, keempat model memiliki nilai $p-value\leq0.05$, sehingga dinyatakan asumsi sisaan saling bebas tidak terpenuhi.

### Uji Heterogenitas

```{r}
bptest(cons_lm1)
bptest(cons_lm2)
bptest(cons_lm3)
bptest(cons_lm4)
```

Dari hasil uji Breusch-Pagan diatas, hanya model pertama yang memiliki nilai $p-value\leq0.05$ sehingga dinyatakan asumsi ragam sisaan homogen tidak terpenuhi. Sedangkan model 2, 3, dan 4 memiliki nilai $p-value>0.05$ sehingga dinyatakan asumsi ragam sisaan homogen terpenuhi.

### Uji Normalitas

```{r}
shapiro.test(residuals(cons_lm1))
shapiro.test(residuals(cons_lm2))
shapiro.test(residuals(cons_lm3))
shapiro.test(residuals(cons_lm4))
```

Dari hasil uji Shapiro-Wilk diatas, hanya model pertama yang memiliki nilai $p-value\leq0.05$ sehingga dinyatakan asumsi normalitas tidak terpenuhi. Sedangkan model 2, 3, dan 4 memiliki nilai $p-value>0.05$ sehingga dinyatakan asumsi normalitas terpenuhi.

# Perbandingan Model

```{r}
akurasi <- matrix(c(mape.koyck, mape.dlm, mape.dlm2, mape.ardl))
row.names(akurasi)<- c("Koyck","DLM 1","DLM 2","Autoregressive")
colnames(akurasi) <- c("MAPE")
akurasi
```

Berdasarkan nilai MAPE, model paling optimum didapat pada Model DLM 1 karena memiliki nilai MAPE yang terkecil.

## Plot

Untuk membandingkan hasil peramalan dari berbagai model (Koyck, DLM 1, DLM 2, dan ARDL) dengan data aktual, dibuat grafik garis. Visualisasi ini membantu melihat seberapa dekat hasil ramalan tiap model dengan nilai aktual.

```{r}
par(mfrow=c(1,1))

plot(test$CO, test$AQI, type="b", col="black", ylim=c(15,80))

points(test$CO, fore.koyck$forecasts, col="red");   lines(test$CO, fore.koyck$forecasts, col="red")
points(test$CO, fore.dlm$forecasts, col="blue");    lines(test$CO, fore.dlm$forecasts, col="blue")
points(test$CO, fore.dlm2$forecasts, col="orange"); lines(test$CO, fore.dlm2$forecasts, col="orange")
points(test$CO, fore.ardl$forecasts, col="green");  lines(test$CO, fore.ardl$forecasts, col="green")

legend("topleft",
       c("Aktual", "Koyck","DLM 1","DLM 2", "Autoregressive"),
       lty=1, col=c("black","red","blue","orange","green"), cex=0.8)
```

Berdasarkan plot perbandingan, terlihat bahwa semua model mampu mengikuti tren data aktual, meskipun dengan tingkat kedekatan yang berbeda. Model koyck (merah) cukup konsisten mendekati data aktual, sementara DLM 2 (oranye) tampak menyimpang cukup jauh. Model DLM 1 (biru) dan model Autoregressive (hijau) terlihat paling mendekati garis data aktual secara keseluruhan.
